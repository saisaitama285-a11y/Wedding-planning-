<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Planner Pro - Detail Rencana</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
    /* Modal Preview Foto */
.modal-photo {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}
.modal-photo.active { display: flex; }
.modal-photo img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 12px;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
}
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .sidebar-link.active {
            background-color: #f43f5e;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(244, 63, 94, 0.2);
        }
        .section-content { display: none; }
        .section-content.active { display: block; }
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #fb7185; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="loader" class="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-rose-500 mb-4"></div>
            <p class="text-rose-500 font-medium">Menyiapkan Detail Persiapan...</p>
        </div>
    </div>

    <div class="min-h-screen flex">
        <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 w-72 bg-white border-r border-gray-100 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="p-6 h-full flex flex-col">
                <div class="flex items-center gap-2 mb-10">
                    <div class="bg-rose-500 p-2 rounded-lg text-white">
                        <i data-lucide="heart" class="fill-current"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800 font-serif">WeddingPro</h1>
                </div>
                
                <nav class="space-y-2 flex-1">
                    <button onclick="switchTab('checklist')" id="btn-checklist" class="sidebar-link active w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-gray-500 hover:bg-rose-50 hover:text-rose-600">
                        <i data-lucide="list-checks"></i>
                        <span class="font-medium">Panduan Lengkap</span>
                    </button>
                    <button onclick="switchTab('seserahan')" id="btn-seserahan" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-gray-500 hover:bg-rose-50 hover:text-rose-600">
                        <i data-lucide="gift"></i>
                        <span class="font-medium">Seserahan & Mahar</span>
                    </button>
                    <button onclick="switchTab('vendor')" id="btn-vendor" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-gray-500 hover:bg-rose-50 hover:text-rose-600">
                        <i data-lucide="briefcase"></i>
                        <span class="font-medium">Daftar Vendor</span>
                    </button>
                    <button onclick="switchTab('prabotan')" id="btn-prabotan" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-gray-500 hover:bg-rose-50 hover:text-rose-600">
                        <i data-lucide="sofa"></i>
                        <span class="font-medium">Isi Rumah</span>
                    </button>
                    <button onclick="switchTab('tabungan')" id="btn-tabungan" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-gray-500 hover:bg-rose-50 hover:text-rose-600">
                        <i data-lucide="piggy-bank"></i>
                        <span class="font-medium">Tabungan</span>
                    </button>
                    <button onclick="switchTab('kas')" id="btn-kas" class="sidebar-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-gray-500 hover:bg-rose-50 hover:text-rose-600">
    <i data-lucide="arrow-up-down"></i>
    <span class="font-medium">Kas Masuk/Keluar</span>
</button>
                </nav>

                <div class="mt-auto p-4 bg-rose-50 rounded-2xl border border-rose-100">
                    <p class="text-[10px] text-rose-400 font-bold uppercase tracking-wider mb-1 text-center">Estimasi Anggaran</p>
                    <p id="grand-total" class="text-lg font-bold text-rose-600 text-center">Rp 0</p>
                    <div class="mt-2 pt-2 border-t border-rose-200">
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider text-center">Kekurangan Dana</p>
                        <p id="gap-total" class="text-sm font-bold text-orange-600 text-center">Rp 0</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 px-6 py-4 flex items-center justify-between sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <button class="lg:hidden p-2 text-gray-500 hover:bg-gray-100 rounded-lg" onclick="toggleSidebar()"><i data-lucide="menu"></i></button>
                    <h2 id="section-title" class="text-lg font-semibold text-gray-700">Checklist Persiapan</h2>
                </div>
                <div id="user-status" class="hidden sm:block text-[10px] text-gray-400 font-mono bg-gray-50 px-3 py-1.5 rounded-full border">UID: ---</div>
            </header>

            <div id="content-scroll" class="flex-1 overflow-y-auto p-4 md:p-8">
                <div id="section-checklist" class="section-content active max-w-4xl mx-auto">
                    <div class="mb-10">
                        <h3 class="text-3xl font-bold text-gray-900 font-serif">Rencana Detail Pernikahan</h3>
                        <p class="text-gray-500 mt-2">Daftar tugas terperinci berdasarkan linimasa ideal.</p>
                    </div>
                    <div id="checklist-timeline" class="space-y-12"></div>
                </div>

                <div id="section-inventory" class="section-content max-w-5xl mx-auto space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <h3 id="inv-title" class="text-2xl font-bold text-gray-800 font-serif capitalize">Manajemen Item</h3>
                            <p class="text-sm text-gray-500">Kelola rincian biaya dan link referensi di sini.</p>
                        </div>
                        <div class="bg-white px-6 py-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4">
                            <div class="p-3 bg-rose-50 text-rose-500 rounded-xl"><i data-lucide="calculator"></i></div>
                            <div>
                                <p id="subtotal-label" class="text-[10px] font-bold text-gray-400 uppercase">Subtotal</p>
                                <p id="subtotal-value" class="text-2xl font-bold text-gray-800">Rp 0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm grid grid-cols-1 md:grid-cols-3 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Nama Item/Kebutuhan</label>
                            <input id="inp-name" type="text" placeholder="Misal: Catering Utama" class="w-full p-3.5 bg-slate-50 border-none rounded-2xl text-sm outline-none transition-all focus:ring-2 focus:ring-rose-200">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Link/Lokasi</label>
                            <input id="inp-link" type="text" placeholder="https://..." class="w-full p-3.5 bg-slate-50 border-none rounded-2xl text-sm outline-none transition-all focus:ring-2 focus:ring-rose-200">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Biaya (Rp)</label>
                            <div class="flex gap-2">
                                <input id="inp-price" type="number" placeholder="0" class="flex-1 p-3.5 bg-slate-50 border-none rounded-2xl text-sm outline-none transition-all focus:ring-2 focus:ring-rose-200">
                                <button onclick="addItem()" class="bg-rose-500 text-white px-6 rounded-2xl hover:bg-rose-600 transition-all active:scale-95 shadow-lg shadow-rose-100">
                                    <i data-lucide="plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50/50">
                                <tr>
                                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Detail Deskripsi</th>
                                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Estimasi Harga</th>
                                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px] text-right">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>

                <div id="section-tabungan" class="section-content max-w-5xl mx-auto space-y-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <h3 class="text-2xl font-bold text-gray-800 font-serif">Catatan Tabungan</h3>
                            <p class="text-sm text-gray-500">Pantau akumulasi dana dari masing-masing pihak.</p>
                        </div>
                        <div class="bg-white px-6 py-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4">
                            <div class="p-3 bg-emerald-50 text-emerald-500 rounded-xl"><i data-lucide="wallet"></i></div>
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase">Total Terkumpul</p>
                                <p id="saving-total-value" class="text-2xl font-bold text-emerald-600">Rp 0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Nama Penabung</label>
                            <input id="inp-saver" type="text" placeholder="Misal: Nama Pria / Wanita" class="w-full p-3.5 bg-slate-50 border-none rounded-2xl text-sm outline-none transition-all focus:ring-2 focus:ring-emerald-200">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Jumlah Setoran (Rp)</label>
                            <div class="flex gap-2">
                                <input id="inp-save-amount" type="number" placeholder="0" class="flex-1 p-3.5 bg-slate-50 border-none rounded-2xl text-sm outline-none transition-all focus:ring-2 focus:ring-emerald-200">
                                <button onclick="addSaving()" class="bg-emerald-500 text-white px-6 rounded-2xl hover:bg-emerald-600 transition-all active:scale-95 shadow-lg shadow-emerald-100">
                                    <i data-lucide="plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50/50">
                                <tr>
                                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Penyetor</th>
                                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Nominal</th>
                                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px] text-right">Tindakan</th>
                                </tr>
                            </thead>
                            <tbody id="savings-table-body" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>
<div id="section-kas" class="section-content max-w-5xl mx-auto space-y-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
        <div>
            <h3 class="text-2xl font-bold text-gray-800 font-serif">Arus Kas (Cashflow)</h3>
            <p class="text-sm text-gray-500">Catat dana masuk dan pengeluaran dengan bukti nota.</p>
        </div>
        <div class="bg-white px-6 py-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4">
            <div class="p-3 bg-blue-50 text-blue-500 rounded-xl"><i data-lucide="trending-up"></i></div>
            <div>
                <p class="text-[10px] font-bold text-gray-400 uppercase">Saldo Kas</p>
                <p id="kas-balance-value" class="text-2xl font-bold text-blue-600">Rp 0</p>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="space-y-1.5">
            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Keterangan</label>
            <input id="inp-kas-desc" type="text" placeholder="Misal: Bayar Tenda" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-200">
        </div>
        <div class="space-y-1.5">
            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Jenis</label>
            <select id="inp-kas-type" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm outline-none">
                <option value="masuk">Uang Masuk (+)</option>
                <option value="keluar">Uang Keluar (-)</option>
            </select>
        </div>
        <div class="space-y-1.5">
            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Tanggal</label>
            <input id="inp-kas-date" type="date" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm outline-none">
        </div>
        <div class="space-y-1.5">
            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Foto Nota</label>
            <input id="inp-kas-file" type="file" accept="image/*" class="w-full text-[10px] text-slate-500 file:mr-2 file:py-2 file:px-3 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700">
        </div>
        <div class="space-y-1.5">
            <label class="text-[11px] font-bold text-gray-500 uppercase px-1">Nominal (Rp)</label>
            <div class="flex gap-2">
                <input id="inp-kas-amount" type="number" placeholder="0" class="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm outline-none">
                <button onclick="addKas()" id="btn-add-kas" class="bg-blue-600 text-white px-5 rounded-xl hover:bg-blue-700 transition-all active:scale-95">
                    <i data-lucide="plus"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
        <table class="w-full text-left text-sm">
            <thead class="bg-slate-50/50">
                <tr>
                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Tanggal & Keterangan</th>
                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Jenis</th>
                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px]">Nominal</th>
                    <th class="px-6 py-5 font-bold text-gray-400 uppercase tracking-widest text-[10px] text-right">Aksi</th>
                </tr>
            </thead>
            <tbody id="kas-table-body" class="divide-y divide-gray-50"></tbody>
        </table>
    </div>
</div>
        </main>
    </div>
<div id="modal-photo" class="modal-photo" onclick="closePreview()">
    <div class="relative max-w-4xl w-full flex justify-center" onclick="event.stopPropagation()">
        <img id="modal-img" src="" alt="Nota Preview">
        <button onclick="closePreview()" class="absolute -top-10 right-0 text-white flex items-center gap-2">
            <i data-lucide="x"></i> Tutup
        </button>
    </div>
</div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, onSnapshot, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJwuNmftdXJxZIwyQq1Cx64DC7Zm1zZ7M",
            authDomain: "weding-planning.firebaseapp.com",
            projectId: "weding-planning",
            storageBucket: "weding-planning.firebasestorage.app",
            messagingSenderId: "989634176070",
            appId: "1:989634176070:web:c961669c8371212661d647"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "wedding-planner-001";

        let currentUser = null;
        let currentTab = 'checklist';
      let data = { seserahan: [], vendor: [], prabotan: [], tabungan: [], checklist: {}, kas: [] }; 

        const timeline = [
    {
        period: "12-9 Bulan Sebelum",
        tasks: [
            { id: 't1', title: 'Tentukan Anggaran & Kontribusi', detail: 'Diskusi detail dana dari pihak pria, wanita, dan orang tua.' },
            { id: 't2', title: 'Pilih Konsep & Warna Utama', detail: 'Modern, adat, atau outdoor? Tentukan palet warna (moodboard).' },
            { id: 't3', title: 'Booking Venue & Tanggal', detail: 'Venue populer biasanya penuh 1 tahun sebelumnya.' },
            { id: 't4', title: 'List Calon Tamu', detail: 'Kumpulkan data alamat dan nomor telepon tamu.' }
        ]
    },
    {
        period: "8-6 Bulan Sebelum",
        tasks: [
            { id: 't5', title: 'Pilih Vendor Katering', detail: 'Test food minimal di 3 vendor berbeda.' },
            { id: 't6', title: 'Fotografer & Videografer', detail: 'Booking untuk hari H dan sesi pre-wedding.' },
            { id: 't7', title: 'MUA & Busana Pengantin', detail: 'Fitting pertama dan pilih perias untuk keluarga.' },
            { id: 't8', title: 'Pre-wedding Photoshoot', detail: 'Lakukan sesi foto agar ada waktu untuk editing.' }
        ]
    },
    {
        period: "5-4 Bulan Sebelum",
        tasks: [
            { id: 't9', title: 'Pesan Cincin Kawin', detail: 'Proses pembuatan/grafir nama biasanya memakan waktu 1-2 bulan.' },
            { id: 't10', title: 'Tentukan Seragam Keluarga', detail: 'Pembelian bahan dan distribusi ke penjahit.' },
            { id: 't11', title: 'Vendor Dekorasi & Hiburan', detail: 'Diskusi layout pelaminan dan daftar lagu (playlist).' },
            { id: 't12', title: 'Cek Kesehatan (Pre-marital)', detail: 'Suntik TT (untuk wanita) dan cek kesehatan umum.' }
        ]
    },
    {
        period: "3 Bulan Sebelum (Krusial)",
        tasks: [
            { id: 't13', title: 'Urus Dokumen KUA/Sipil', detail: 'Siapkan surat pengantar RT/RW, foto latar biru, dan berkas asli.' },
            { id: 't14', title: 'Finalisasi Undangan', detail: 'Cetak dummy, cek penulisan nama, dan naik cetak.' },
            { id: 't15', title: 'Beli Seserahan & Mahar', detail: 'Lengkapi semua barang seserahan untuk mulai dihias.' },
            { id: 't16', title: 'Pilih Menu Final', detail: 'Tentukan komposisi gubukan dan menu prasmanan.' }
        ]
    },
    {
        period: "1 Bulan - H-2 Minggu",
        tasks: [
            { id: 't17', title: 'Distribusi Undangan', detail: 'Pastikan semua tamu sudah menerima undangan (fisik/digital).' },
            { id: 't18', title: 'Technical Meeting (TM)', detail: 'Pertemuan koordinasi seluruh vendor di venue.' },
            { id: 't19', title: 'Final Fitting', detail: 'Pastikan berat badan stabil dan baju nyaman dipakai.' },
            { id: 't20', title: 'Konfirmasi Jumlah Tamu', detail: 'Update final RSVP ke vendor katering.' }
        ]
    },
    {
        period: "H-1 Minggu - Hari H",
        tasks: [
            { id: 't21', title: 'Manicure, Pedicure, Spa', detail: 'Relaksasi tubuh sebelum hari yang melelahkan.' },
            { id: 't22', title: 'Packing Barang Bawaan', detail: 'Siapkan koper berisi baju ganti, alat ibadah, dan obat pribadi.' },
            { id: 't23', title: 'Gladi Bersih', detail: 'Latihan prosesi akad/pemberkatan dan resepsi.' },
            { id: 't24', title: 'Istirahat Total', detail: 'Tidur cukup agar wajah segar dan tidak mengantuk.' }
        ]
    }
];

        window.onload = () => {
            signInAnonymously(auth).catch(console.error);
            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-status').innerText = `ID: ${user.uid.slice(0,8)}`;
                    initDatabase();
                    document.getElementById('loader').classList.add('hidden');
                }
            });
        };

        function initDatabase() {
    onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'checklist', 'status'), snap => {
        data.checklist = snap.exists() ? snap.data() : {};
        if (currentTab === 'checklist') renderChecklist();
    });

    ['seserahan', 'vendor', 'prabotan', 'tabungan', 'kas'].forEach(col => {
        onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', col)), snap => {
            data[col] = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Trigger render sesuai tab yang aktif
            if (currentTab === 'kas') renderKas();
            if (currentTab === 'tabungan') renderSavings();
            if (['seserahan', 'vendor', 'prabotan'].includes(currentTab)) renderInventory();
            
            updateTotals();
        });
    });
}

        window.switchTab = (tabId) => {
    currentTab = tabId;
    
    // Reset visual sidebar
    document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
    document.getElementById(`btn-${tabId}`)?.classList.add('active');
    
    // Sembunyikan semua section
    document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
    
    // Update Judul
    const titles = { 
        checklist: 'Panduan Lengkap', 
        seserahan: 'Manajemen Seserahan', 
        vendor: 'Daftar Vendor', 
        prabotan: 'Isi Rumah', 
        tabungan: 'Tabungan Bersama', 
        kas: 'Arus Kas' 
    };
    document.getElementById('section-title').innerText = titles[tabId];
    
    // Logika pemilihan section (PENTING)
    if (tabId === 'kas') {
        document.getElementById('section-kas').classList.add('active');
        renderKas();
    } else if (tabId === 'checklist') {
        document.getElementById('section-checklist').classList.add('active');
        renderChecklist();
    } else if (tabId === 'tabungan') {
        document.getElementById('section-tabungan').classList.add('active');
        renderSavings();
    } else {
        // Ini hanya untuk seserahan, vendor, dan prabotan
        document.getElementById('section-inventory').classList.add('active');
        document.getElementById('inv-title').innerText = `Daftar ${tabId}`;
        document.getElementById('subtotal-label').innerText = `Subtotal ${tabId}`;
        renderInventory();
    }

    if (window.innerWidth < 1024) toggleSidebar();
};

        function renderChecklist() {
            const container = document.getElementById('checklist-timeline');
            container.innerHTML = timeline.map(section => `
                <div class="space-y-6">
                    <div class="flex items-center gap-4"><div class="h-px bg-rose-200 flex-1"></div><span class="text-rose-500 font-bold text-xs uppercase bg-rose-50 px-4 py-1.5 rounded-full border border-rose-100">${section.period}</span><div class="h-px bg-rose-200 flex-1"></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${section.tasks.map(task => {
                            const isDone = data.checklist[task.id] || false;
                            return `<div onclick="window.toggleCheck('${task.id}')" class="p-5 bg-white border rounded-3xl flex gap-4 cursor-pointer hover:border-rose-400 transition-all ${isDone ? 'bg-slate-50 border-slate-200' : 'border-gray-100'}">
                                <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${isDone ? 'bg-rose-500 border-rose-500 text-white' : 'border-gray-200'}">${isDone ? '<i data-lucide="check" size="14"></i>' : ''}</div>
                                <div><h4 class="font-bold text-gray-800 ${isDone ? 'line-through text-gray-400' : ''}">${task.title}</h4><p class="text-xs text-gray-500 mt-1">${task.detail}</p></div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        // Fungsi untuk kompres foto otomatis
const compressImage = (file, maxWidth = 800, quality = 0.7) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                // Hitung rasio agar foto tetap proporsional
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Ubah menjadi Base64 dengan kualitas 0.7 (70%)
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedBase64);
            };
        };
        reader.onerror = (error) => reject(error);
    });
};

        function renderInventory() {
            const list = data[currentTab] || [];
            const tbody = document.getElementById('inventory-table-body');
            let sub = 0;
            tbody.innerHTML = list.length === 0 ? '<tr><td colspan="3" class="p-10 text-center text-gray-400 italic">Belum ada rincian ditambahkan.</td></tr>' : list.map(item => {
                sub += Number(item.price) || 0;
                return `<tr class="hover:bg-rose-50/20 group"><td class="px-6 py-5"><div class="font-semibold text-gray-800">${item.name}</div>${item.link ? `<a href="${item.link}" target="_blank" class="text-[10px] text-rose-400 flex items-center gap-1 mt-1"><i data-lucide="external-link" size="10"></i> Link</a>` : ''}</td><td class="px-6 py-5 font-mono font-bold text-gray-700">Rp ${(Number(item.price) || 0).toLocaleString('id-ID')}</td><td class="px-6 py-5 text-right"><button onclick="removeItem('${item.id}')" class="text-gray-200 hover:text-rose-500 p-2"><i data-lucide="trash-2" size="18"></i></button></td></tr>`;
            }).join('');
            document.getElementById('subtotal-value').innerText = `Rp ${sub.toLocaleString('id-ID')}`;
            lucide.createIcons();
        }

        function renderSavings() {
            const list = data.tabungan || [];
            const tbody = document.getElementById('savings-table-body');
            let total = 0;
            tbody.innerHTML = list.length === 0 ? '<tr><td colspan="3" class="p-10 text-center text-gray-400 italic">Belum ada tabungan.</td></tr>' : list.map(item => {
                total += Number(item.price) || 0;
                return `<tr class="hover:bg-emerald-50/20"><td class="px-6 py-5 font-semibold text-gray-800">${item.name}</td><td class="px-6 py-5 font-mono font-bold text-emerald-600">Rp ${(Number(item.price) || 0).toLocaleString('id-ID')}</td><td class="px-6 py-5 text-right"><button onclick="removeItem('${item.id}')" class="text-gray-200 hover:text-rose-500 p-2"><i data-lucide="trash-2" size="18"></i></button></td></tr>`;
            }).join('');
            document.getElementById('saving-total-value').innerText = `Rp ${total.toLocaleString('id-ID')}`;
            lucide.createIcons();
        }

        function updateTotals() {
            const totalCost = ['seserahan', 'vendor', 'prabotan'].reduce((acc, col) => acc + (data[col] || []).reduce((s, i) => s + (Number(i.price) || 0), 0), 0);
            const totalSaved = (data.tabungan || []).reduce((s, i) => s + (Number(i.price) || 0), 0);
            document.getElementById('grand-total').innerText = `Rp ${totalCost.toLocaleString('id-ID')}`;
            document.getElementById('gap-total').innerText = `Rp ${Math.max(0, totalCost - totalSaved).toLocaleString('id-ID')}`;
        }

        window.toggleCheck = async (id) => { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'checklist', 'status'), { ...data.checklist, [id]: !data.checklist[id] }); };
        
        window.addItem = async () => {
            const n = document.getElementById('inp-name').value;
            const p = document.getElementById('inp-price').value;
            const l = document.getElementById('inp-link').value;
            if (!n || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', currentTab), { name: n, price: Number(p) || 0, link: l, date: new Date().toISOString() });
            document.getElementById('inp-name').value = ''; document.getElementById('inp-price').value = ''; document.getElementById('inp-link').value = '';
        };


        window.addSaving = async () => {
            const n = document.getElementById('inp-saver').value;
            const p = document.getElementById('inp-save-amount').value;
            if (!n || !p || !currentUser) return;
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'tabungan'), { name: n, price: Number(p) || 0, date: new Date().toISOString() });
            document.getElementById('inp-saver').value = ''; document.getElementById('inp-save-amount').value = '';
        };
        // Fungsi mengubah file gambar menjadi string teks (Base64)
const toBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
});

window.addKas = async () => {
    const desc = document.getElementById('inp-kas-desc').value;
    const type = document.getElementById('inp-kas-type').value;
    const amount = document.getElementById('inp-kas-amount').value;
    const dateManual = document.getElementById('inp-kas-date').value;
    const fileInput = document.getElementById('inp-kas-file');
    const btn = document.getElementById('btn-add-kas');

    if (!desc || !amount || !currentUser) return alert("Keterangan dan nominal wajib diisi!");

    btn.disabled = true;
    // Animasi loading sederhana
    btn.innerHTML = '<div class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>';

    try {
        let photoData = "";
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            // Kompres foto sebelum simpan
            photoData = await compressImage(file, 800, 0.6); // Max lebar 800px, kualitas 60%
        }

        const finalDate = dateManual || new Date().toISOString().split('T')[0];

        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'kas'), {
            name: desc,
            type: type,
            price: Number(amount) || 0,
            date: finalDate,
            photo: photoData
        });

        // Reset Form
        document.getElementById('inp-kas-desc').value = '';
        document.getElementById('inp-kas-amount').value = '';
        document.getElementById('inp-kas-file').value = '';
        document.getElementById('inp-kas-date').value = '';
        
    } catch (err) {
        console.error("Gagal simpan:", err);
        alert("Terjadi kesalahan saat menyimpan data.");
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i data-lucide="plus"></i>';
        lucide.createIcons();
    }
};
window.renderKas = () => {
    const list = data.kas || [];
    list.sort((a, b) => new Date(b.date) - new Date(a.date));
    const tbody = document.getElementById('kas-table-body');
    let balance = 0;

    tbody.innerHTML = list.length === 0 ? '<tr><td colspan="4" class="p-10 text-center text-gray-400 italic">Belum ada mutasi kas.</td></tr>' : list.map(item => {
        const isMasuk = item.type === 'masuk';
        balance += isMasuk ? item.price : -item.price;

        return `
            <tr class="hover:bg-slate-50/50">
                <td class="px-6 py-5">
                    <div class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">${item.date || '-'}</div>
                    <div class="font-semibold text-gray-800 flex items-center gap-2">
                        ${item.name}
                        ${item.photo ? `
                            <button onclick="showPreview('${item.photo}')" class="text-blue-500 hover:scale-110 transition-transform">
                                <i data-lucide="image" size="14"></i>
                            </button>` : ''}
                    </div>
                </td>
                <td class="px-6 py-5">
                    <span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase ${isMasuk ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}">
                        ${item.type}
                    </span>
                </td>
                <td class="px-6 py-5 font-mono font-bold ${isMasuk ? 'text-emerald-600' : 'text-rose-600'}">
                    ${isMasuk ? '+' : '-'} Rp ${item.price.toLocaleString('id-ID')}
                </td>
                <td class="px-6 py-5 text-right">
                    <button onclick="removeItem('${item.id}')" class="text-gray-200 hover:text-rose-500 p-2"><i data-lucide="trash-2" size="18"></i></button>
                </td>
            </tr>`;
    }).join('');

    document.getElementById('kas-balance-value').innerText = `Rp ${balance.toLocaleString('id-ID')}`;
    lucide.createIcons();
};

window.showPreview = (base64) => {
    const modalImg = document.getElementById('modal-img');
    const modalDiv = document.getElementById('modal-photo');
    
    if (modalImg && modalDiv) {
        modalImg.src = base64;
        modalDiv.classList.add('active');
    } else {
        console.error("Elemen modal tidak ditemukan di HTML!");
    }
};

window.closePreview = () => {
    const modalDiv = document.getElementById('modal-photo');
    if (modalDiv) modalDiv.classList.remove('active');
};

        window.removeItem = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', currentTab, id)); };
        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebarOverlay').classList.toggle('hidden'); };
    </script>
</body>
</html>